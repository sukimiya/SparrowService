
<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title></title>
        <link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="css/switchery.min.css" rel="stylesheet" type="text/css">
        <link href="css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css">
        <link href="css/Chart.min.css" rel="stylesheet" type="text/css">
        <link href="css/main.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <div class="container-fluid">
          <div class="d-flex col-md-12 align-content-stretch flex-wrap panel">
              <canvas id="myChart" width="400" height="400"></canvas>
          </div>
        </div>

        <script src="js/jquery.min.js" type="text/javascript"></script>
        <script src="js/popper.min.js" type="text/javascript"></script>
        <script src="js/bootstrap.bundle.min.js" type="text/javascript"></script>
        <script src="js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
        <script src="js/switchery.min.js" type="text/javascript"></script>
        <script src="js/moment.min.js" type="text/javascript"></script>
        <script src="js/Chart.min.js" type="text/javascript"></script>
<script type="text/javascript">

Date.prototype.format = function(fmt)
{ //author: meizz
	var o = {
		"M+" : this.getMonth()+1,                 //月份
		"d+" : this.getDate(),                    //日
		"h+" : this.getHours(),                   //小时
		"m+" : this.getMinutes(),                 //分
		"s+" : this.getSeconds(),                 //秒
		"q+" : Math.floor((this.getMonth()+3)/3), //季度
		"S"  : this.getMilliseconds()             //毫秒
	};
	if(/(y+)/.test(fmt))
		fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
	for(var k in o)
		if(new RegExp("("+ k +")").test(fmt))
			fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
	return fmt;
}
function getMouthDates(date){
    var start = new Date(date);
    start.setDate(1);
    var end = new Date(start);
    var rs = [];
    for(i=0;i<32;i++){
        end.setDate(start.getDate()+i);
        if(end.getMonth() === start.getMonth()){
            rs.push(new Date(end));
        }else{
            break;
        }
    }
    return rs;
}
function getLoginLog(date){
    return new Promise(function(resolve,reject){
        $.ajax({
            url:"http://101.132.193.16:9307/loginLog?date="+date.format("yyyy/MM/dd"),
            datType:"json",
            success:function(res){
                // console.log(res);
                resolve({res:res,date:date.format("yyyy/MM/dd")});
            },
            fail:function(res){
                console.log(res);
                reject(res);
            }
        });
    });
}
function drawChart(){
    var ctx = document.getElementById('myChart');
    var labels = [];
    var dataSets = [];
    for(var a in counts){
        labels.push(a);
        dataSets.push(counts[a]);
    }
    var myChart = new Chart(ctx, {
        type: 'bar',
        data:{labels:labels,datasets:[{
            label:"# of logins",
            data:dataSets,
            borderWidth:1
        }]},
        options:{
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });
}
var result = {};
var counts = {};
$(document).ready(function () {
    var newDate = new Date();
    var rs = getMouthDates(newDate);
    var promises = [];

    for(var i=0;i<rs.length;i++)
        promises.push(getLoginLog(rs[i]));
    Promise.all(promises).then(function(res){
        for(var i=0;i<res.length;i++){
            var obj = JSON.parse(res[i].res);
            if(obj&&obj.length){
                var dayStr = obj[0].logins[0].time;
                var day = new Date(dayStr);
                var dateNum = day.getDate();
                result[dateNum]=obj;
                counts[res[i].date]=obj.length;
                console.log(res[i].date+":logins:"+obj.length);
            }else{
                counts[res[i].date] = 0;
                console.log(res[i].date+":logins:0");
            }

        }
    }).catch(function(res){
        console.log(res);
    }).finally(function(){
        drawChart();
    });
});

        </script>
    </body>
</html>
