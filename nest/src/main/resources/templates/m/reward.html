<!DOCTYPE html>
<!--
  ~ Project:sparrow nest
  ~ LastModified:18-4-25 下午4:44 by sukimiya
  ~
  ~ Copyright (C) 2018.  e2x.io
  ~
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU General Public License as published by
  ~ the Free Software Foundation, either version 3 of the License, or
  ~ (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with this program.  If not, see <http://www.gnu.org/licenses/>.
  -->
<%
include("../header.btl",{title:"Sparrow Nest"}){}
%>
<%
include("../topnav.btl"){}
%>
<div class="bg-light">
    <div class="container d-flex justify-content-between page-header">
        <h1 class="p-2 align-self-center current-title">
            Reword
        </h1>
        <%
        if(isHasDispatcher){
        %>
        <div class="option-btn-group">
            <a class="btn btn-primary p-2 justify-content-end shadow mb-5 rounded-circle option-btn" data-toggle="modal" data-target="#creatRewordModal">
                <span class="iconfont float-btn" aria-hidden="true">&#xe6da;</span>
            </a>
        </div>
        <%
        }
        %>
    </div>
</div>
<div class="container s-page-content fully">
    <div class="justify-content-md-center">

        <!--form class="form-inline d-flex justify-content-between gap">
            <div class="form-group">
                <label for="startOfDate">开始</label>
                <input id="startOfDate" type="text" class="form-control" data-date="2019/04/13" data-date-format="yyyy/mm/dd">
            </div>
            <div class="form-group">
                <label for="endOfDate">结束</label>
                <input id="endOfDate" type="text" class="form-control" data-date="2019/04/14" data-date-format="yyyy/mm/dd">
            </div>
            <div class="form-group">
                <label for="key">ID</label>
                <input type="text" class="form-control" id="key" name="key" placeholder="Search for..." value="">
                <a class="btn btn-primary form-control iconfont glyphicon" onclick="refreshListData();">&#xe6a4;</a>
            </div>
        </form-->
        <div id="chatlist" class="list-group col-lg">
            <div class="list-group-item form-group search-box">
                <div class="input-group">
                    <input id="key" type="text" class="form-control" name="key" placeholder="道具名" value="">
                    <!--<span class="input-group-btn">-->

                    <!--</span>-->
                    <a class="btn btn-primary iconfont text-lg-center" onclick="searchByItemName();">&#xe65c;</a>
                </div>

            </div>
        </div>
        <div class="col-lg">
            <a class="btn btn-default iconfont form-control" onclick="nextPage();">&#xe79f;</a>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="creatRewordModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div id="ModelDialogEdit" class="modal-dialog bg-light d-flex flex-column" role="document">
        <div class="modal-content">
            <div class="modal-header d-flex justify-content-between">
                <button type="button" class="close align-self-left" data-dismiss="modal" aria-label="Close">
                    <span class="iconfont" aria-hidden="true">&#xe679;</span>
                </button>
                <h5 class="modal-title-blue align-self-center">Create a Reword</h5>
                <a class="modal-title-blue align-self-right" href="#">
                    <span class="iconfont" aria-hidden="true" style="color:transparent;">&#xe679;</span>
                </a>
            </div>
            <form id="edituserform" action="#" method="post">
                <div class="modal-body">

                    <div class="form-group">
                        <label for="role" title="可以用多个角色，中间用, 号分开">角色</label>
                        <textarea class="form-control" id="role" name="role" rows="4"></textarea>
<!--                        <input type="text" class="form-control" id="role" name="role" aria-describedby="可以用多个角色，中间用, 号分开" rows="12" placeholder="角色名称">-->
                    </div>
                    <div class="form-group">
                        <label for="itemType" title="可以用多个道具，中间用, 号分开">道具ID</label>
                        <textarea class="form-control" id="itemType" name="itemType" rows="4"></textarea>
<!--                        <input type="text" class="form-control" id="itemType" name="itemType" aria-describedby="可以用多个道具，中间用, 号分开" rows="12" placeholder="输入道具类型ID">-->
                    </div>
                    <div class="form-group">
                        <label for="itemName">道具名称</label>
                        <input type="text" class="form-control" id="itemName" name="itemName" placeholder="请输入道具名称">
                    </div>
                    <div class="form-group">
                        <label for="num">数目</label>
                        <input type="text" class="form-control" id="num" name="num" placeholder="1" value="1">
                    </div>
                </div>
                <div class="modal-footer">
                    <a class="btn btn-primary form-control" onclick="createReword(event)">CREATE</a>
                </div>
            </form>
        </div>
    </div>
</div>
<div id="sendComfirmDialog" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">发送</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>确定要发送道具吗?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="onSendClick()">发送</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<%
include("../scripts.btl"){}
%>
<script type="text/javascript">

    function chatListAddItem(dataitem) {
        var hitem = '<div class="list-group-item chat-list-item"><div class="d-flex justify-content-between"><div class="d-flex flex-column justify-content-center col-md-3"><div class="text-left align-self-center" style="font-size: x-small">' +
            dataitem.role +
            '</div></div>' +
            '<div class="d-flex flex-column justify-content-center col-md-3"><div class="text-left align-self-center" style="font-size: x-small">' + parseTimestamp(dataitem.timestamp)  +
            '</div></div>' +
            '<div class="d-flex flex-column justify-content-center col-md-3"><div class="text-left align-self-center" style="font-size: x-small">' + dataitem.itemName + " (" + dataitem.num + ")" +
            '</div></div>';
        if(dataitem.sent)
            hitem += '<div class="d-flex flex-column justify-content-center col-md-3"><div class="text-left"><h5>已发送</h5></div>';
        else
            hitem += '<div class="d-flex flex-column justify-content-center col-md-3"><div class="text-left"><a class="btn btn-default" href="#" onclick="sentReword(\''+dataitem.ssn+'\')">' + dataitem.ssn + '</a></div>';

        hitem += '</div></div></div>';
        $('#chatlist').append(hitem);
    }
    function createReword(event) {
        var typeId = $("#itemType").val();
        var num = parseInt($("#num").val());
        var typeName = $("#itemName").val();
        var role = $("#role").val();
        var postData = JSON.stringify({role:role,itemType:typeId,itemName:typeName,num:num});
        $.ajax({
            url:"/gm/createreword",
            type:"POST",
            contentType:"application/json",
            data:postData,
            datType:"json",
            async: false,
            success:function(data){
                $("#creatRewordModal").modal("hide");
                refreshListData();
            },
            fail:function (data) {
                $("#creatRewordModal").modal("hide");
                // removeLoading();
            }
        });
    }
    var CurrentSelectSSN = "";
    function onSendClick() {
        if(CurrentSelectSSN != "")
            $.ajax({
                url:"/gm/sendReword?ssn="+CurrentSelectSSN,
                type:"POST",
                success:function (res) {
                    // try{
                    //     var data = JSON.parse(res);
                    //     console.log(res);
                    // }catch(e){
                    //     console.log(e);
                    // }
                    refreshListData();
                }
            });
        $("#sendComfirmDialog").modal("hide");
    }
    function sentReword(ssn) {
        CurrentSelectSSN = ssn;
        $("#sendComfirmDialog").modal("show");

    }
    function searchByItemName() {
        if($("#key").val() && $("#key").val()!=""){

        }else{
            return;
        }
        var keyStr = $("#key").val();
        currentPage = 0;
        $.ajax({
            url:"/gm/getrewords",
            data:JSON.stringify({key:keyStr}),
            type:"POST",
            contentType:"application/json",
            datType:"json",
            async: false,
            success:function(data){
                $('.chat-list-item').remove();
                for(var i=0;i<data.length;i++){
                    var dataitem = data[i];
                    chatListAddItem(dataitem);
                }
            },
            fail:function (data) {

            }
        });
    }
    var currentPage = 0;
    function nextPage(){
        currentPage ++;
        var senddata;
        if($("#key").val() && $("#key").val()!=""){
            senddata = {page:currentPage,key:$("#key").val()};
        }else{
            senddata = {page:currentPage}
        }
        $.ajax({
            url:"/gm/getrewords",
            data:JSON.stringify(senddata),
            type:"POST",
            contentType:"application/json",
            datType:"json",
            async: false,
            success:function(data){
                // $('.chat-list-item').remove();
                for(var i=0;i<data.length;i++){
                    var dataitem = data[i];
                    chatListAddItem(dataitem);

                }
            },
            fail:function (data) {
                
            }
        });
    }
    function refreshListData(){
        showLoading();
        $.ajax({
            url:"/gm/getrewords",
            data:JSON.stringify({}),
            type:"POST",
            contentType:"application/json",
            datType:"json",
            async: false,
            success:function(data){
                $('.chat-list-item').remove();
                console.log("refreshListData"+data.length);
                for(var i=0;i<data.length;i++){
                    var dataitem = data[i];
                    //var keyval = $("#key").val();
                    //if(keyval && keyval !== ""){
                    //     var keyval = $("#key").val();
                    //     if(dataitem.account === keyval){
                            chatListAddItem(dataitem);
                    //     }else{
                    //         continue;
                    //     }
                    // }else{
                    //     chatListAddItem(dataitem);
                    // }

                }
                removeLoading();
            },
            fail:function (data) {
                removeLoading();
            }
        });
    }
    $(document).ready(function () {
        // var today = new Date();
        // var yestody = new Date();
        // yestody.setDate(today.getDate()-1);
        // $('#startOfDate').datetimepicker({
        //     minView:2,
        //     autoclose:true,
        //     todayBtn:true,
        //     todayHighlight:true
        // });
        // $('#endOfDate').datetimepicker({
        //     minView:2,
        //     autoclose:true,
        //     todayBtn:true,
        //     todayHighlight:true
        // });
        // $('#startOfDate').val(yestody.format("yyyy/MM/dd"));
        // $('#endOfDate').val(today.format("yyyy/MM/dd"));

        refreshListData();
    });
</script>
<%
include("../footer.btl"){}
%>
